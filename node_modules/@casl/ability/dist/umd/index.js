!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("sift")):"function"==typeof define&&define.amd?define(["exports","sift"],t):t((e=e||self).casl={},e.sift)}(this,function(e,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function u(e,t){void 0===t&&(t={}),Error.call(this),this.constructor=u,this.subject=t.subject,this.subjectName=t.subjectName,this.action=t.action,this.field=t.field,this.message=e||'Cannot execute "'+this.action+'" on "'+this.subjectName+'"',"function"==typeof Error.captureStackTrace?(this.name=this.constructor.name,Error.captureStackTrace(this,this.constructor)):this.stack=new Error(this.message).stack}function h(e){return Array.isArray(e)?e:[e]}function a(e){if(!e||"string"==typeof e)return e;var t="object"==typeof e?e.constructor:e;return t.modelName||t.name}n=n&&n.hasOwnProperty("default")?n.default:n,u.prototype=Object.create(Error.prototype);var c=function(){function e(e){this.actions=e.actions||e.action,this.subject=e.subject,this.fields=e.fields&&0!==e.fields.length?h(e.fields):void 0,this.inverted=!!e.inverted,this.conditions=e.conditions,this._matches=this.conditions?n(this.conditions):void 0,this.reason=e.reason}var t=e.prototype;return t.matches=function(e){return!this._matches||("string"==typeof e?!this.inverted:this._matches(e))},t.isRelevantFor=function(e,t){return!this.fields||(t?-1!==this.fields.indexOf(t):!this.inverted)},e}(),d="undefined"!=typeof Symbol?Symbol("private"):"__"+Date.now(),l={crud:["create","read","update","delete"]};function i(e,t){return e===t||Array.isArray(t)&&-1!==t.indexOf(e)}var f=function(){function e(e,t){var n=void 0===t?{}:t,r=n.RuleType,i=void 0===r?c:r,s=n.subjectName,o=void 0===s?a:s;this[d]={RuleType:i,subjectName:o,originalRules:e||[],indexedRules:Object.create(null),mergedRules:Object.create(null),events:{},aliases:function(e){return JSON.parse(JSON.stringify(e))}(l)},this.update(e)}e.addAlias=function(e,t){if("manage"===e||i("manage",t))throw new Error('Cannot add alias for "manage" action because it represents any action');if(i(e,t))throw new Error("Attempt to alias action to itself: "+e+" -> "+t.toString());return l[e]=t,this};var t=e.prototype;return t.update=function(e){if(Array.isArray(e)){var t={rules:e,ability:this};this.emit("update",t),this[d].originalRules=Object.freeze(e.slice(0)),this[d].indexedRules=this.buildIndexFor(e),this[d].mergedRules=Object.create(null),this.emit("updated",t)}return this},t.buildIndexFor=function(e){for(var t=Object.create(null),n=this[d].RuleType,r=0;r<e.length;r++)for(var i=new n(e[r]),s=this.expandActions(i.actions),o=h(i.subject),a=e.length-r-1,u=0;u<o.length;u++){var c=o[u];t[c]=t[c]||Object.create(null);for(var l=0;l<s.length;l++){var f=s[l];t[c][f]=t[c][f]||Object.create(null),t[c][f][a]=i}}return t},t.expandActions=function(e){for(var t=this[d].aliases,n=h(e),r=0;r<n.length;){var i=n[r++];t.hasOwnProperty(i)&&(n=n.concat(t[i]))}return n},t.can=function(e,t,n){var r=this.relevantRuleFor(e,t,n);return!!r&&!r.inverted},t.relevantRuleFor=function(e,t,n){for(var r=this.rulesFor(e,t,n),i=0;i<r.length;i++)if(r[i].matches(t))return r[i];return null},t.possibleRulesFor=function(e,t){var n=this[d].subjectName(t),r=this[d].mergedRules,i=n+"_"+e;return r[i]||(r[i]=this.mergeRulesFor(e,n)),r[i]},t.mergeRulesFor=function(r,e){var i=this[d].indexedRules;return[e,"all"].reduce(function(e,t){var n=i[t];return n?Object.assign(e,n[r],n.manage):e},[]).filter(Boolean)},t.rulesFor=function(e,t,n){return this.possibleRulesFor(e,t).filter(function(e){return e.isRelevantFor(t,n)})},t.cannot=function(){return!this.can.apply(this,arguments)},t.throwUnlessCan=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=this.relevantRuleFor.apply(this,t);if(!r||r.inverted){var i=t[0],s=t[1],o=t[2],a=this[d].subjectName(s);throw new u(r?r.reason:null,{action:i,subjectName:a,subject:s,field:o})}},t.on=function(t,n){var r=this[d].events,i=!0;return r[t]||(r[t]=[]),r[t].push(n),function(){if(i){var e=r[t].indexOf(n);r[t].splice(e,1),i=!1}}},t.emit=function(e,t){var n=this[d].events[e];n&&n.slice(0).forEach(function(e){return e(t)})},function(e,t,n){t&&r(e.prototype,t),n&&r(e,n)}(e,[{key:"rules",get:function(){return this[d].originalRules}}]),e}();function o(e){return![].concat(e).some(function(e){return"string"!=typeof e})}function p(e){return e&&"object"==typeof e}var v=function(){function e(e){this.rule=e}return e.prototype.because=function(e){return this.rule.reason=e,this},e}(),t=function(){function e(e){var t=(void 0===e?{}:e).subjectName,n=void 0===t?a:t;this.rules=[],this.subjectName=n}e.define=function(e,t){var n="function"==typeof e?{}:e,r=e===n?t:e,i=new this(n),s=r(i.can.bind(i),i.cannot.bind(i)),o=function(){return new f(i.rules,n)};return s&&"function"==typeof s.then?s.then(o):o()},e.extract=function(){var e=new this;return{can:e.can.bind(e),cannot:e.cannot.bind(e),rules:e.rules}};var t=e.prototype;return t.can=function(e,t,n,r){if(!o(e))throw new TypeError("AbilityBuilder#can expects the first parameter to be an action or array of actions");var i=[].concat(t).map(this.subjectName);if(!o(i))throw new TypeError("AbilityBuilder#can expects the second argument to be a subject name/type or an array of subject names/types");var s={actions:e,subject:i};return(Array.isArray(n)||"string"==typeof n)&&(s.fields=n),(p(r)||!s.fields&&p(n))&&(s.conditions=r||n),this.rules.push(s),new v(s)},t.cannot=function(){var e=this.can.apply(this,arguments);return e.rule.inverted=!0,e},e}();e.Ability=f,e.AbilityBuilder=t,e.ForbiddenError=u,e.Rule=c,e.RuleBuilder=v,Object.defineProperty(e,"__esModule",{value:!0})});
